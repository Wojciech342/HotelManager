<div class="container-fluid p-0 mt-2">
  <div class="row">
    <!-- Filters Sidebar -->
    <div class="col-lg-2 col-md-3 col-12 px-3 sidebar-sticky">
      <div class="card shadow-sm border-0 mb-4" style="border-radius: 1rem">
        <div class="card-body">
          <h5 class="fw-bold mb-4 text-primary">
            <i class="bi bi-funnel-fill me-2"></i>Filters
          </h5>
          <form [formGroup]="filterForm" (ngSubmit)="onFilter()">
            <!-- Room Types -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-secondary"
                >Room Types</label
              >
              <div class="d-flex flex-wrap gap-2">
                <ng-container *ngFor="let type of roomTypes">
                  <div class="form-check form-check-inline">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      [value]="type"
                      (change)="onTypeChange($event)"
                      [checked]="selectedTypes.includes(type)"
                      id="type-{{ type }}"
                    />
                    <label
                      class="form-check-label small"
                      [for]="'type-' + type"
                      >{{ type }}</label
                    >
                  </div>
                </ng-container>
              </div>
            </div>
            <div class="mb-4">
              <label class="form-label fw-semibold text-secondary"
                >Price Range</label
              >
              <ngx-slider
                *ngIf="isBrowser"
                [(value)]="minValue"
                [(highValue)]="maxValue"
                [options]="sliderOptions"
                (userChangeEnd)="
                  filterForm.patchValue({
                    minPrice: minValue,
                    maxPrice: maxValue
                  })
                "
              ></ngx-slider>
              <div class="d-flex justify-content-between mt-2">
                <span class="badge bg-light text-dark border">
                  {{ minValue | currency }}
                </span>
                <span class="badge bg-light text-dark border">
                  {{ maxValue | currency }}
                </span>
              </div>
            </div>
            <div class="mb-4">
              <label class="form-label fw-semibold text-secondary"
                >Min Rating</label
              >
              <div>
                <app-star-rating formControlName="minRating"></app-star-rating>
              </div>
            </div>
            <!-- Buttons -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary w-100 shadow-sm">
                <i class="bi bi-search me-1"></i>Filter
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary w-100 shadow-sm"
                (click)="clearFilters()"
              >
                <i class="bi bi-x-circle me-1"></i>Clear
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Rooms List -->
    <div class="col-lg-10 col-md-9 col-12">
      <h2 class="fw-bold mb-4">Available Rooms</h2>
      <div class="row g-4">
        <div class="col-12" *ngFor="let room of rooms">
          <div
            class="card shadow-sm border-0 room-card flex-row align-items-stretch h-100"
          >
            <div
              class="room-img-wrapper d-flex align-items-center justify-content-center"
              style="min-width: 220px; background: #f8f9fa"
            >
              <img
                *ngIf="room.imageUrl"
                [src]="room.imageUrl"
                alt="Room image"
                class="img-fluid rounded-start"
                style="max-width: 200px; max-height: 160px; object-fit: cover"
              />
              <span *ngIf="!room.imageUrl" class="text-muted">No image</span>
            </div>
            <div class="card-body d-flex flex-column justify-content-between">
              <div>
                <div class="d-flex align-items-center mb-2">
                  <h4 class="card-title fw-bold mb-0 me-2">
                    Room {{ room.number }}
                  </h4>
                  <span class="badge bg-secondary ms-2">{{ room.type }}</span>
                </div>
                <div class="mb-2">
                  <span class="me-3"
                    ><i class="bi bi-people-fill me-1"></i> Capacity:
                    {{ room.capacity }}</span
                  >
                </div>
                <div class="mb-2">
                  <span class="me-3">
                    <i class="bi bi-star-fill text-warning"></i>
                    <span class="fw-bold">{{
                      roundToOneDecimal(room.averageRating)
                    }}</span>
                  </span>
                  <span>
                    <i class="bi bi-cash-coin text-success"></i>
                    <span class="fw-bold">{{
                      room.pricePerNight | currency
                    }}</span>
                    / night
                  </span>
                </div>
              </div>
              <div class="mt-3">
                <button
                  class="btn btn-success px-4"
                  [routerLink]="['/make-reservation', room.id]"
                >
                  Make a Reservation
                </button>
              </div>
              <!-- Add this button inside each room card, below the reservation button -->
              <div class="mt-2">
                <button
                  class="btn btn-outline-info"
                  (click)="openReviewsModal(room)"
                >
                  <i class="bi bi-chat-dots me-1"></i>See Reviews
                </button>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="rooms.length === 0" class="col-12">
          <div class="alert alert-info text-center">
            No rooms found matching your criteria.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reviews Modal Backdrop -->
<div *ngIf="showReviewsModal" class="modal-backdrop-custom"></div>
<!-- Reviews Modal -->
<div *ngIf="showReviewsModal" class="modal-dialog-custom modal-dialog-reviews">
  <div class="modal-header-custom mb-3">
    <i class="bi bi-chat-dots text-info fs-3 me-2"></i>
    <span class="fw-bold fs-4 text-primary">Room Reviews</span>
    <button
      type="button"
      class="btn-close ms-auto"
      aria-label="Close"
      (click)="closeReviewsModal()"
    >
      x
    </button>
  </div>
  <div
    *ngIf="selectedRoomReviews?.length === 0"
    class="alert alert-info text-center rounded-3 shadow-sm"
  >
    <i class="bi bi-info-circle me-2"></i>
    There are no reviews for this room yet.
  </div>
  <div *ngIf="(selectedRoomReviews?.length ?? 0) > 0" class="reviews-list">
    <div
      *ngFor="let review of selectedRoomReviews"
      class="review-item mb-4 p-3 rounded-3 shadow-sm"
    >
      <div class="d-flex align-items-center mb-2">
        <i class="bi bi-person-circle fs-4 text-secondary me-2"></i>
        <span class="fw-semibold text-dark">{{ review.username }}</span>
      </div>
      <div class="text-muted fst-italic mb-1" style="font-size: 1.05rem">
        "{{ review.description }}"
      </div>
      <div>
        <app-star-rating
          [ngModel]="review.rating"
          [readonly]="true"
          size="sm"
        ></app-star-rating>
      </div>
    </div>
  </div>
</div>
